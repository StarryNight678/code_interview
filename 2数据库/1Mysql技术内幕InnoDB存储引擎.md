# Mysql技术内幕InnoDB存储引擎

图书**Mysql技术内幕InnoDB存储引擎**

## 各存储引擎间比较
- 性能:

innodDb上存储超过1T数据,处理插入更新操作大约800次每秒.

## InnoDB存储引擎

1. 第一个完整支持ACID
1. 行锁设计
1. MVCC: Multi-Version Concurrency Control 多版本并发控制
1. 外键
1. 一致性非锁定读

数据库的应用类型分为

1. OLTP(OnLine Transaction Processing ，联机事务处理)
1. OLAP(OnLine Analysis Processing，联机分析处理)两种。

OLTP是传统关系型数据库的主要应用，其主要面向基本的、日常的事务处理，例如银行交易。

OLAP是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。

![](http://image20.it168.com/201207_500x375/1111/4070a8d25582419d.jpg)

# 文件
# 表
# 索引与算法

- InnoDB索引类型

1. B+树索引
1. 全文索引
1. 哈希索引

B+树索引分为:

1. 聚集索引
1. 辅助索引:非聚集索引

内部都是B+树,高度平衡. 区别是内部是否存放一整行数据.

## 哈希算法

## 全文索引

采用倒排索引

word  文章id  位置


# 锁

MyIsam 表锁设计: 并发读没问题.并发插入性能差些.

InnoDb 行锁,提供一致性非锁定读,行锁没有额外开销. 没有锁的升级.


## latch 轻量级锁

要求锁定时间短.

InnoDB分为

1. 互斥锁 mutex ; show engine InnoDB mutex
1. 读写锁


没有检测死锁机制

## lock

对象是事务

具有死锁检测机制

- 锁类型

1. 共享锁: 允许读一行数据
1. 排他锁:  允许事务删除或更新一行数据


都是行锁

1. 意向锁: 不同粒度上加锁操作.**表级别的锁**.不会阻塞除全表扫描外的任何请求.


## 一致性非锁定读

通过多版本控制机制,来读取当前执行中的数据库中的行.

通过行快照方式.不需要等待行上的,锁释放.

多版本并发机制MVCC

## 一致性锁定读

SELECT *　　FOR  UPDATE 　　　　　　排他锁
SELECT *　  LOCK  IN  SHARE  MODE　　共享锁


## 自增长锁

## 死锁问题

解决方法:

1. 超时.
1. 普遍采用等待图方式.主动死锁检测.

## 锁升级

粒度降低

行锁升级为页锁.

InnoDB不存在锁升级问题.

根据页进行加锁. 采用位图方法.


# 事务


事务是数据库区别于文件系统的重要特征之一.


## 事务隔离分为不同级别，包括读

1. 未提交（Read uncommitted）
1. 读提交（read committed）
1. 可重复读（repeatable read）
1. 和串行化（Serializable）

InnoDB是可重复读,隔离级别.通过next-key lock 锁算法,避免幻读产生.

幻读 : 是指当事务不是独立执行时发生的一种现象

## ACID

1. 原子性：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。
1. 一致性：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。
1. 隔离性：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。
1. 持久性：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

事务分类

1. 扁平事务
1. 带有保存点的扁平事务
1. 链事务
1. 分布式事务: 分布式环境下的扁平事务

原子性,一致性,持久性通过数据库的redo日志和 undo日志来实现

redo 重做日志来保证事务的原子性和持久性.

undo 保证一致性.

redo和undo都是一种恢复操作.

1. redo 恢复提交事务,修改的修改的页操作.物理日志.记录页的物理修改操作.
1. undo 回滚记录到某个特定版本.逻辑日志.根据每行进行记录.

# 备份与恢复
# 性能调优